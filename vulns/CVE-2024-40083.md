# [CVE-2024-40083](https://www.cve.org/CVERecord?id=CVE-2024-40083): Buffer Overflow in `local_app_set_router_token()`
* **CVSS Score** - 9.6, Critical ([CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H))
* **Overview** - An attacker connected to the router's LAN can interact with the local service running on port 5432. When changing the timezone and token for the router through the `local_app_set_router_token()` function, the function `sscanf()` is run that reads a string from the user-supplied packet into a 17-byte buffer, leading to a buffer overflow. This occurs twice in the function.
* **Description**
    * Anyone on the LAN can interact with the service running on port 5432, which uses a custom protocol to receive commands from the user's Vilo app mainly for setup purposes. An unauthenticated attacker can implement this protocol (which uses XXTEA encryption) to send custom messages and commands through this service. One of the commands it takes is changing the router's token and timezone, which is processed in the `local_app_set_router_token()` function of the `hlRouterApp` binary. 
    * This function will take in and process a char array in JSON format like `{"token":"t=token&tz=timezone"}`. However, when extracting both the token and the timezone parameters from the `token` attribute, it uses `sscanf(user_input, "t=%s", &token)` and `sscanf(user_input, "tz=%s", &timezone)` which does not check the length of the string read into the destination buffers. 
    * This means a payload like `{"token":"t=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&tz=timezone"}` would overflow the buffer and modify the stack. In the latest version of the firmware, stack canaries are present; in older versions, there are no canaries. 
* **Impact** - Anyone with regular access to the WiFi (LAN) can exploit this buffer overflow and may be able to gain root access to the Vilo router through Remote Code Execution.