# [CVE-2024-40085](https://www.cve.org/CVERecord?id=CVE-2024-40085): Buffer Overflow in `local_app_set_router_wan()`
* **CVSS Score** - 9.6, Critical ([CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H))
* **Overview** - An attacker connected to the router's LAN can interact with the local service running on port 5432. When setting the PPPoE username and password, the cJSON library extracts the string for `pppoe_username` and `pppoe_password`, runs them through the `Base64Decode` function, then XORs it with a 64-byte key. It then copies the output into a 128-byte buffer on the stack using a for loop that copies the entire length of the field over. Since the length of the username and password is never checked, values over 128 bytes in length will modify other stack values and lead to memory corruption.
* **Description**
    * Anyone on the LAN can interact with the service running on port 5432, which uses a custom protocol to receive commands from the user's Vilo app mainly for setup purposes. An unauthenticated attacker can implement this protocol (which uses XXTEA encryption) to send custom messages and commands through this service. One of the commands it takes is connecting the router to the WAN by using `pppoe_username` and `pppoe_password`, which is processed in the `local_app_set_router_wan()` function of the `hlRouterApp` binary. 
    * This function will take in and process a char array in JSON format like `{"pppoe_username":"asdf", "pppoe_password": "asdf"}`. However, when extracting and decrypting both username and password parameters, the length of the fields is never checked but they are copied into fixed-size buffers of 128 bytes each. Thus, a buffer overflow is present for both fields.
    * This means a payload like `{"pppoe_username":"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA", "pppoe_password": "BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"}` would overflow the buffer and modify the stack. In the latest version of the firmware, stack canaries are present; in older versions, there are no canaries. 
* **Impact** - Anyone with regular access to the WiFi (LAN) can exploit this buffer overflow and may be able to gain root access to the Vilo router through Remote Code Execution.